---
title: How to Extract Dynamic DEX Loading
date: 2023-01-17
author: glasses96
categories: [Mobile, Android]
tags: [Android, Dex, Dex Extract]
pin: true
math: true
mermaid: true
---

> **μµκ·Ό λ¨λ°”μΌ μ§„λ‹¨ μ¤‘ λ£¨ν…νƒμ§€λ¥Ό ν•κ³  μμ§€λ§ μ–΄λ””μ„ νΈμ¶ν•λ”μ§€λ¥Ό μ°Ύμ„ μκ°€ μ—†μ—λ”λ° μ–΄μ°μ €μ° ν•λ‹¤κ°€ Dynamic Dex Loadingμ΄ μ μ©λ κ²ƒμ„ λ°κ²¬ ν•μ€μµλ‹λ‹¤.**  
> **Dynamic Dex Loadingμ„ ν•λ” Appμ—μ„ DEXλ¥Ό μ¶”μ¶ν•λ” λ°©λ²•λ“¤μ— λ€ν•΄μ„ μ•μ•„λ΄…μ‹λ‹¤.**
{: .prompt-info }

---

## Dynamic Dex Loading π”µβοΈπ”΄
Dynamic Dex Loading κΈ°λ²•μ€ APP λ¶„μ„μ„ μ–΄λ µκ² ν•κΈ° μ„ν•΄ μ‚¬μ©ν•λ” λ‚λ…ν™” κΈ°λ²•μ…λ‹λ‹¤.
λ³΄ν†µμ€ APKλ‚΄ μΌλ°μ μΈ κ²½λ΅(classes.dex)κ°€ μ•„λ‹ λ‹¤λ¥Έ κ²½λ΅(assets, App λ‚΄λ¶€ μ €μ¥μ†)μ— μ•”νΈν™”λμ–΄ μ €μ¥λμ–΄ μμΌλ©° μ•±μ΄ μ‹¤ν–‰λ  λ• λ³µνΈν™”λμ–΄ λ©”λ¨λ¦¬μ— λ΅λ“ λ©λ‹λ‹¤.
λ³µνΈν™” κ³Όμ •μ„ κ±°μΉ ν›„ μ‚­μ  λκΈ° λ•λ¬Έμ— μΌλ°μ μΌλ΅λ” μ°ΎκΈ°κ°€ μ–΄λ µμµλ‹λ‹¤.

----

## How to Extract Dynamic DEX?
μ•”νΈν™”λ DEXλ¥Ό λ³µνΈν™” ν•λ” λ°©λ²•μ€ Java Code λ‚΄μ—μ„ ν•  μλ„ μκ³  JNI Library νμΌμ„ ν†µν• λ³µνΈν™”λ“±μ΄ μμµλ‹λ‹¤. λ‚λ…ν™” λ APPμ—μ„ μ•”νΈν™” λ DEX νμΌμ„ μ°Ύκ³  λ³µνΈν™” λ°©λ²•μ„ μ°Ύλ” λ°©λ²•μ€ μ‹κ°„μ΄ λ§μ΄ μ†μ”λ©λ‹λ‹¤.

λΉ λ¥Έ μ‹κ°„ λ‚΄ μ°νλ¥Ό ν•κΈ° μ„ν•΄μ„λ” <span style="color:#9999FF">λ³µνΈν™”λ DEXκ°€ λ©”λ¨λ¦¬μ— λ΅λ“λκ±°λ‚ μ‚­μ λλ‹¤λ” κ²ƒ</span>μΌλ΅ μ‹μ‘ν•  μ μμµλ‹λ‹¤.

λ‹¤μκ³Ό κ°™μ€ μ°ν λ°©λ²•μ„ μƒκ°ν•  μ μμµλ‹λ‹¤.

1. Android κΈ°κΈ° λ‚΄ ν΄λ” λ³µμ‚¬
2. λ©”λ¨λ¦¬μ— μ¬λΌκ°„ λ³µνΈν™” λ DEX μ¶”μ¶
3. JNI Library ν•¨μ ν›„ν‚Ή


-----
## Find Dymanic DEX Loading

κ°€μ¥ λ¨Όμ € Dynamic DEX Loading κΈ°λ²•μ„ μ‚¬μ©ν•κ³  μλ”μ§€ ν™•μΈμ„ ν•΄μ•Όν•©λ‹λ‹¤.
ν™•μΈν•λ” λ°©λ²•μΌλ΅λ” loadDEX(), openDexFile() ν•¨μ ν›„ν‚Ήμ„ ν†µν•΄ μΈμ κ°’μ—μ„ ν™•μΈν•  μ μμµλ‹λ‹¤.
μ¶”κ°€μ μΌλ΅ /proc/{pid}/maps | grep delete λ…λ Ήμ–΄λ¥Ό ν†µν•΄ λ©”λ¨λ¦¬μ—μ„ μ‚­μ λ DEXλ¥Ό ν™•μΈν•  μ μμµλ‹λ‹¤.

----


## Dynamic Dex Extract - Shell Script

<span style="color:#9999FF">Android κΈ°κΈ° λ‚΄ ν΄λ” λ³µμ‚¬λ¥Ό ν†µν•΄ DEX νμΌμ„ μ¶”μ¶ν•λ” λ°©λ²•</span>μ…λ‹λ‹¤.
Shell Sciptλ΅ μ‚­μ λλ” DEX ν΄λ”μ μ„μΉλ¥Ό μ•κ³  μμ„ λ• 0.1μ΄λ§λ‹¤ ν•΄λ‹Ή ν΄λ”λ¥Ό μ§€μ›μ§€μ§€μ•λ„λ΅ λ‹¤λ¥Έ ν΄λ”μ— λ³µμ‚¬λ¥Ό ν•λ” λ°©λ²•μ…λ‹λ‹¤.

```bash
#!/system/bin/sh
cnt=0
while [ 1 ]
do
    if [ $cnt -ge 0]; then
        echo "Copy Dex -->>>>>>>";
        cp -r {DEX ν΄λ”} /sdcard/test/DEX$cnt;
        fi
    cnt=$(($cnt+1))
    sleep 0.1
done
```

---
## Dynamic Dex Extract - JNI Function
JNI Library ν•¨μμ—μ„ νμΌμ„ μ‚­μ μ‹ν‚¤λ” ν•¨μλ¥Ό ν›„ν‚Ήν•μ—¬ μ‚­μ ν•μ§€ μ•λ„λ΅ ν•λ” λ°©λ²•μ…λ‹λ‹¤.
Unlink(), Remove() ν•¨μλ“±μ΄ μμµλ‹λ‹¤.

<span style="color:#9999FF">unlink()ν•¨μκ°€ μ‹¤ν–‰λ λ• NativeCallbackμΌλ΅ ν•¨μλ¥Ό μ¬μ •μ ν•μ—¬ μ‚­μ κ°€ μ•„λ‹ console.warn() λ§ μ‹¤ν–‰</span>λλ„λ΅ ν•©λ‹λ‹¤.
```javascript
function unlink(){
    var unlink = Module.findExportByName(null, 'unlink');
    var open = new NativeFunction(unlink, 'void', ['int']);
    Interceptor.replace(open, new NativeCallback(function(){
    console.warn('[*] unlink Hook complete');  
    }, 'void', ['int']));
}
```

---
## Dynamic Dex Extract - Memory Load DEX
<span style="color:#9999FF">λ³µνΈν™”λ DEXλ” λ©”λ¨λ¦¬μ— λ΅λ“λκΈ° λ•λ¬Έμ— λ©”λ¨λ¦¬μ—μ„ λ³µνΈν™”λ DEXλ¥Ό μ¶”μ¶ν•λ” λ°©λ²•</span>μ…λ‹λ‹¤.

β—οΈβ—οΈμ›ν•λ” DEXλ¥Ό μ¶”μ¶ν•μ—¬λ„ λ””μ»΄νμΌμ΄ λμ§€ μ•λ”λ‹¤λ©΄ λ°”μ΄λ„λ¦¬ νΈμ§‘ λ„κµ¬(HxD)λ¥Ό μ΄μ©ν•μ—¬ DEX μ‹κ·Έλ‹μ²(64 65 78 0a 30)λ¥Ό μ°Ύμ•„ λ¶ν•„μ”ν• μμ—­μ„ μ§€μ›μ•Ό ν•©λ‹λ‹¤.
```javascript
Java.perform(function (){
    var ThreadDef = Java.use('java.lang.Thread');
    var ThreadObj = ThreadDef.$new();
    
    function stackTrace() {
        var stack = ThreadObj.currentThread().getStackTrace();
        for (var i = 0; i < stack.length; i++) {
            console.log(i + " => " + stack[i].toString());
        }
        console.log("-------------------------------------");
    }
       
        var DexFile = Java.use("dalvik.system.DexFile");
        DexFile.loadDex.overload('java.lang.String', 'java.lang.String', 'int', 'java.lang.ClassLoader', '[Ldalvik.system.DexPathList$Element;').implementation = function(sourcepath, outputPathName, flags,arg4,arg5){
            console.warn(sourcepath);
            if(outputPathName.indexOf("{μ°Ύλ”dex}")>-1){
               console.log("[*] arg1 : "+sourcepath);
            }
            ExtractDexFile();
            return this.loadDex(sourcepath, outputPathName, flags,arg4,arg5)
        }
    })

    function ExtractDexFile() {
        console.warn('Dex Extract');
        Process.enumerateRanges('r--').forEach(function (range) {
            try {
                if(range.file.path && (range.file.path.startsWith("/data/dalvik-cache/") || range.file.path.startsWith("/system/") || range.file.path.startsWith("/dev/"))) {
                    return;
                }
                else {
                    Memory.scanSync(range.base, range.size, "64 65 78 0a 30 ?? ?? 00").forEach(function (match) {
                        console.log('\x1b[32m[*] file_path : ' + range.file.path + '\x1b[0m');
                        var dex_addr = match.address;
                        var dex_size = dex_addr.add(0x20).readUInt();
                        console.log('\x1b[33m[*] dex_addr : ' + dex_addr + '\x1b[0m');
                        console.log('\x1b[36m[*] dex_size : ' + dex_size + '\x1b[0m');
                        if(range.file.path.indexOf("{μ°Ύλ” DEX μ΄λ¦„}")>-1){
                            var file = new File("{μƒμ„±ν•  DEX File Name}", "wb");
                            file.write(Memory.readByteArray(dex_addr, dex_size));
                            file.flush();
                            file.close();
                        }
                    });
                }
                
            } catch (e) {}
        })
        console.warn('[!] Extract Complete ! :)');
    }

//frida -U -f com.kakaobank.channel -l a.js --no-pause
```

----
# Reference

[https://blog.naver.com/gigs8041/222137154226](https://blog.naver.com/gigs8041/222137154226)
[https://www.igloo.co.kr/security-information/μ•…μ„±-apkμ„-μ΄μ©ν•-dynamic-dex-loading-λ¶„μ„/](https://www.igloo.co.kr/security-information/%EC%95%85%EC%84%B1-apk%EC%9D%84-%EC%9D%B4%EC%9A%A9%ED%95%9C-dynamic-dex-loading-%EB%B6%84%EC%84%9D/)

----
# ν›„κΈ°
Android μ—¬λ¬ λ²„μ „μ—μ„ μ‹λ„λ¥Ό ν•΄λ΄¤λ”λ° λ¨λ“  λ²„μ „μ΄ λμ§€ μ•μ•μµλ‹λ‹¤.
μ”κ±΄ λκ³  μ €κ±΄ μ•λκ³ ... λ‹¤λ¥Έ λ²„μ „μ—μ„  μ”κ² λκ³  λ‹¤λ¥Έκ² μ•λκ³ .... μ‹ κΈ° ν–μ§€λ§ μ™ μ•λλ”μ§€λ” κ²°κµ­ λ»μ°Ύμ•μµλ‹λ‹¤π±π± μ•„μ§ λ§μ΄ λ¶€μ΅±ν•κΈ°μ—.. λ” μ—΄μ‹¬ν ν•΄μ•Όκ² μµλ‹λ‹¤